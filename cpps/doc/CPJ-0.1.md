CPJ Format Specification v0.1
=============================

Purpose
-------

CPJ is a schema for representing:

* A triangulated surface
* A collection of circle packing projective structures dual to that triangulation
* A collection of lists of edges of the triangulation

In order to describe the format, we first describe the representation
of a triangulated surface as a data structure: The doubly-connected
edge list.

The Doubly-Connected Edge List (DCEL)
-------------------------------------

Following [de Berg et al][dBCvKO] we represent an oriented
surface decomposed into polygonal cells using three linked data
structures.  All of the attributes of the objects in these data
structures are references; in describing them we say "an X" in place
of "a reference to an X".

* V, the _vertex structure_, is a collection of vertex objects.  A
  vertex object `v` represents a vertex of the triangulated surface,
  and has a single attribute `leaving`, which is a half-edge object
  representing an oriented edge originating at this vertex.
  
* E, the _half-edge structure_, is a collection of half-edge objects.  A
  half-edge object `e` represents an oriented edge of the triangulated
  surface, and has the following attributes:
 
    * `face` : The face that has this oriented edge as part of its
      (positively oriented) boundary
      
    * `next` : The half-edge after `e` in the boundary of `e.face`
      
    * `prev` : The half-edge before `e` in the boundary of `e.face`
       
    * `twin` : The half-edge representing the the same edge as `e`, but
       with the opposite orientation
       
    * `src` : The vertex that this oriented edge points away from.
       
* F, the _face structure_, is a collection of face objects.  A face
   object `f` represents a face of the triangulated surface, and has a
   single attribute `edge` which is one of the half-edges in the
   boundary of this face.
   
 
We consider DCELs `D = {V,E,F}` that are _indexed_, meaning that each
of the collections `D.V`, `D.E`, `D.F` is an array rather than an
unordered container.  Thus each vertex, half-edge, or face object in
`D` has a well-defined zero-based index in its associated array.

The ordering of `D.E` also determines an ordering for the set of
unoriented edges of the cell structure.  Here, we compare unoriented
edges according to the smallest index in `D.E` of an oriented
representative.  The index of an unoriented edge refers to its
position in this ordering.

Cross ratio vectors for circle packings
---------------------------------------

Following [Kojima, Mizushima, and Tan][KMT], a circle packing
projective structure is represented by map `X` from the set of unoriented
edges of its dual graph to the real numbers.  In this description, an
unoriented edge `ue` corresponds to a configuration of four circles in
the Riemann sphere with certain tangencies, and `X(ue)` is the cross
ratio of four of the tangency points.  See [the paper][KMT] for details.

In order to represent `X` as an array, we use the ordering of
unoriented edges described above.  That is, `X[k]` is the cross ratio
of the unoriented edge appearing in position `k` when sorted according
to the minimum index in `D.E` of a representing half-edge.

Variants, file extension
------------------------
There are two variants of this file format:

* CPJ, a JSON file following the schema below, with extension `.cpj`
* Compressed CPJ, a gzip-compressed JSON file satisfying the schema
  below, with extension `.cpz`
  
File format
-----------
A CPJ file contains a JSON object with the following attributes:

* `metadata` : _Required attribute._  The value is an object.  Attributes of
  this object describe the contents of the file.
  * Required attributes/values: 
    * `schema` : The string `"cpj"`
    * `schema_version` : The string `"0.1"`
  * Optional attributes with fixed meaning:
    * `timestamp` : The UTC date and time of creation of the file, in the
      ISO 8601-compliant format generated by Javascript's
      Date.toJSON() method.  (Example `"2015-10-26T07:46:36.611Z"`)
    * `description` : A string describing the contents of the file
  * Arbitrary additional attributes are permitted in the `metadata`
    object.
    
* `dcel` : _Required attribute._  The value is an object.  This object is a
  JSON representation of the indexed doubly-connected edge list `D` of
  an oriented triangulated surface.
  * Required attributes/values: 
    * `uuid` : A UUID of the triangulation in canonical form (as in
      RFC 4122)
      
    * `vertices` : An array of integers of length `len(D.V)`.  The integer `vertices[k]`
      is the  index of `D.V[k].leaving` in `D.E`.
      
    * `edges` : An array of objects of length `len(D.E)`.  The object
      `edges[k]` represents the edge `e = D.E[k]` and has the
      following attributes:
          * `face` : The index `e.face` in `D.F`
          * `next` : The  index of `e.next` in `D.E`
          * `prev` : The  index of `e.prev` in `D.E`
          * `twin` : The  index of `e.twin` in `D.E`
          * `src` : The  index of `e.src` in `D.V`
    * `faces` : An array of integers of length `len(D.F)`.  The
      integer `faces[k]` is the  index of `D.F[k].edge` in
      `D.E`.
    * No other attributes are permitted in the `dcel` object.
    
* `edge_lists` : _Optional attribute._  If present, the value is an
  array, an object, or `null`.  Each element (array case) or value (object
  case) is an array of integers which are indices of edges in
  `dcel.edges`.  A value of `null` is equivalent to the absence of the
  `edge_lists` attribute, in the sense that either case is permitted
  and indicates that the file does not store any edge lists.

* `packings` : _Optional attribute._  If present, the value is an array,
  an object, or `null`.  Each element (array case) or value (object
  case) is a numpy.ndarray with real floating-point data type,
  represented in JSON as described below.  Each such element is the
  cross ratio vector of a circle packing projective structure dual to
  the triangulation represented by the DCEL.  A value of `null` is
  equivalent to the absence of the `packings` attribute, in the
  sense that either case is permitted and indicates that the file does
  not store any circle packing projective structures.
 
JSON representation of numpy.ndarray
------------------------------------

We use the following convention to serialize a numpy.ndarray object `X`
to a JSON object (as suggested in
[http://stackoverflow.com/a/24375113](http://stackoverflow.com/a/24375113)
).  There are exactly three attributes:

* `__ndarray__` : A string containing the base64-encoded C_CONTIGUOUS
  backing data of `X`, as produced by the python code
  
        if X.flags['C_CONTIGUOUS']:
            return base64.b64encode(X.data)
        else:
            return base64.b64encode(numpy.ascontiguousarray(X).data)

* `dtype` : A string representation of the numpy.dtype of the array,
  as produced by the python code `str(X.dtype)`.
  
* `shape` : An array of integers giving the shapre of the array.

The ndarray objects in a CPJ file must be a one-dimensional real
floating-point arrays of length equal to the number of unoriented
edges of the DCEL.  The allowable `dtype` values are therefore:

* `half` or `e`
* `single` or `f`
* `double`
* `float_` or `d`
* `longfloat` or `g`
* `float16`
* `float32`
* `float64`
* `float96`
* `float128`

[dBCvKO]: http://www.cs.uu.nl/geobook/ "M. de Berg, O. Cheong, M. van Kreveld, and M. Overmars.  Computational Geometry: Algorithms and Applications, 3ed.  Springer-Verlag, 2008."

[KMT]: http://projecteuclid.org/euclid.jdg/1090426770  "Kojima, S. Mizushima and S. P. Tan. Circle Packings on Surfaces with Projective Structures.  J. Differential Geom. 63, No. 3 (2003), 349-397."

